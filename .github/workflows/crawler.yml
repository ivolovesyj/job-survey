name: Zighang Crawler

on:
  # 매일 새벽 3시에 자동 실행 (KST 기준)
  schedule:
    - cron: '0 18 * * *'  # UTC 18:00 = KST 03:00
  
  # 수동 실행 가능
  workflow_dispatch:
    inputs:
      resume:
        description: 'Resume from last run (true/false)'
        required: false
        default: 'false'

jobs:
  crawl:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6시간 제한
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Create .env file
        run: |
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> .env
          echo "SUPABASE_SERVICE_KEY=${{ secrets.SUPABASE_SERVICE_KEY }}" >> .env
      
      - name: Download previous crawl state (for resume)
        if: github.event.inputs.resume == 'true'
        uses: actions/download-artifact@v4
        with:
          name: crawl-state-latest
          path: .
        continue-on-error: true
      
      - name: Run crawler with resume support
        run: |
          if [ "${{ github.event.inputs.resume }}" = "true" ]; then
            echo "Resuming from last run..."
            node src/index.js --resume
          else
            echo "Starting fresh crawl..."
            node src/index.js
          fi
        timeout-minutes: 350  # 워크플로우 타임아웃보다 약간 짧게
        continue-on-error: true
        id: crawler
      
      - name: Save crawl state (on timeout or error)
        if: always()
        run: |
          if [ -f crawl-state.json ]; then
            echo "Crawl state saved for resume"
            echo "CRAWL_STATE_EXISTS=true" >> $GITHUB_ENV
          fi
      
      - name: Upload crawl state artifact
        if: always() && env.CRAWL_STATE_EXISTS == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: crawl-state-latest
          path: crawl-state.json
          retention-days: 7
      
      - name: Notify on completion
        if: always()
        run: |
          if [ "${{ steps.crawler.outcome }}" = "success" ]; then
            echo "✅ Crawler completed successfully"
          else
            echo "⚠️ Crawler stopped (timeout or error) - use 'Resume' to continue"
          fi
      
      - name: Trigger resume workflow (auto-resume on timeout)
        if: failure() || cancelled()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'crawler.yml',
              ref: 'main',
              inputs: {
                resume: 'true'
              }
            });
            console.log('Auto-resume workflow triggered');
        continue-on-error: true
